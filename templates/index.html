<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作日历系统</title>
    <link href="{{ url_for('static', filename='libs/bootstrap.min.css') }}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 顶部导航 -->
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">工作日历系统</a>
                    <div class="navbar-nav ms-auto">
                        <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#taskListModal">任务列表</button>
                        <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#issueListModal">问题列表</button>
                        <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#workflowConfigModal">工作流列表</button>
                    </div>
                </div>
            </nav>
        </div>
        
        <!-- 横向滚动公告栏 -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info mb-0 py-2" style="background: linear-gradient(90deg, #e3f2fd, #f3e5f5); border: none;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-bullhorn me-2"></i>
                        <div class="overflow-hidden flex-grow-1">
                            <div id="announcementScroll" class="announcement-scroll">
                                <span id="announcementContent">正在加载已解决问题...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <!-- 左侧日历 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">任务日历</h5>
                        <button class="btn btn-primary btn-sm rounded-circle" data-bs-toggle="modal" data-bs-target="#addTaskModal" title="添加任务" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="calendar"></div>
                    </div>
                </div>
                
                <!-- 工作流程步骤 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">工作流程步骤</h5>
                        <select id="workflowSelect" class="form-select mt-2">
                            <option value="">选择工作类型</option>
                            <!-- 选项将通过JavaScript动态加载 -->
                        </select>
                    </div>
                    <div class="card-body">
                        <div id="workflowSteps">
                            <div class="text-center text-muted py-4">请选择工作流查看步骤</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧问题清单和分析 -->
            <div class="col-md-4">
                <!-- 问题清单 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">待解决问题</h5>
                        <button class="btn btn-primary btn-sm rounded-circle" data-bs-toggle="modal" data-bs-target="#addIssueModal" title="添加问题" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="issuesList">
                            {% for issue in issues %}
                            <div class="issue-item mb-3 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ issue.title }}</h6>
                                        <p class="mb-1 text-muted small">{{ issue.description }}</p>
                                        {% if issue.priority == 'high' %}
                                        <span class="badge bg-danger">{{ issue.priority }}</span>
                                        {% elif issue.priority == 'medium' %}
                                        <span class="badge bg-warning">{{ issue.priority }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ issue.priority }}</span>
                                        {% endif %}
                                    </div>
                                    <button class="btn btn-sm btn-outline-success" onclick="resolveIssue('{{ issue.id }}')">解决</button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- 任务处理速度分析 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">任务处理分析</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-12 mb-3">
                                <div class="border rounded p-3 bg-gradient bg-light">
                                    <h6 class="mb-2">专家评级</h6>
                                    <div class="d-flex justify-content-center align-items-center">
                                        <span class="h4 text-primary mb-0 fw-bold" id="expertLevel">专家等级：LV 0，当前是 未知 专家</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="border rounded p-2">
                                    <h6 class="mb-1">本月完成</h6>
                                    <div class="d-flex justify-content-center align-items-center">
                                        <span class="h4 text-success mb-0" id="monthlyCompleted">0</span>
                                        <span class="ms-2 badge" id="monthCompareChange"></span>
                                    </div>
                                    <small class="text-muted" id="lastMonthCompleted">上月: 0</small>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h6 class="mb-2">任务类型统计</h6>
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="taskTypeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加任务模态框 -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaskForm">
                        <div class="mb-3">
                            <label for="taskTitle" class="form-label">任务标题</label>
                            <input type="text" class="form-control" id="taskTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskDescription" class="form-label">任务描述</label>
                            <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="taskType" class="form-label">任务类型</label>
                            <select class="form-select" id="taskType" required onchange="calculateTaskStatus()">
                                <option value="">选择任务类型</option>
                                <option value="五年战略规划">五年战略规划</option>
                                <option value="商业计划">商业计划</option>
                                <option value="管理报告">管理报告</option>
                                <option value="临时报告">临时报告</option>
                                <option value="创新管理">创新管理</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="taskPriority" class="form-label">优先级</label>
                            <select class="form-select" id="taskPriority" required>
                                <option value="medium" selected>中</option>
                                <option value="high">高</option>
                                <option value="low">低</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="taskStartDate" class="form-label">开始日期</label>
                            <input type="datetime-local" class="form-control" id="taskStartDate" required onchange="calculateTaskStatus(); validateDates()">
                        </div>
                        <div class="mb-3">
                            <label for="taskDeadline" class="form-label">截止日期（可选）</label>
                            <input type="datetime-local" class="form-control" id="taskDeadline" onchange="calculateTaskStatus(); validateDates()">
                            <div id="dateValidationFeedback" class="invalid-feedback" style="display: none;">
                                起始日期必须早于或等于截止日期
                            </div>
                        </div>
                        <div class="mb-3" style="display: none;">
                            <label for="taskStatus" class="form-label">任务状态</label>
                            <input type="text" class="form-control" id="taskStatusDisplay" readonly placeholder="系统将根据日期自动计算状态">
                            <input type="hidden" id="taskStatus" value="pending">
                            <small class="form-text text-muted">状态将根据开始日期和截止日期自动计算</small>
                        </div>
                        <div class="mb-3" style="display: none;">
                            <label for="taskProgress" class="form-label">任务进展</label>
                            <select class="form-select" id="taskProgress">
                            </select>
                            <small class="form-text text-muted">仅在任务状态为"进行中"时可选择具体进展步骤</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addTask()">添加任务</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加问题模态框 -->
    <div class="modal fade" id="addIssueModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新问题</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addIssueForm">
                        <div class="mb-3">
                            <label for="issueTitle" class="form-label">问题标题</label>
                            <input type="text" class="form-control" id="issueTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="issueDescription" class="form-label">问题描述</label>
                            <textarea class="form-control" id="issueDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="issuePriority" class="form-label">优先级</label>
                            <select class="form-select" id="issuePriority">
                                <option value="low">低</option>
                                <option value="medium" selected>中</option>
                                <option value="high">高</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addIssue()">添加问题</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 问题清单模态框 -->
    <div class="modal fade" id="issueListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">问题清单</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 问题分类标签 -->
                    <ul class="nav nav-tabs" id="issueListTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="open-issues-tab" data-bs-toggle="tab" data-bs-target="#open-issues" type="button" role="tab">
                                未解决问题 <span id="openIssuesCount" class="badge bg-danger">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="resolved-issues-tab" data-bs-toggle="tab" data-bs-target="#resolved-issues" type="button" role="tab">
                                已解决问题 <span id="resolvedIssuesCount" class="badge bg-success">0</span>
                            </button>
                        </li>
                    </ul>
                    
                    <!-- 问题列表内容 -->
                    <div class="tab-content" id="issueListTabContent">
                        <div class="tab-pane fade show active" id="open-issues" role="tabpanel">
                            <div class="mt-3">
                                <div id="openIssuesList" class="issue-list">
                                    <!-- 未解决问题将在这里显示 -->
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="resolved-issues" role="tabpanel">
                            <div class="mt-3">
                                <div id="resolvedIssuesList" class="issue-list">
                                    <!-- 已解决问题将在这里显示 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="refreshIssueList()">刷新</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 任务列表模态框 -->
    <div class="modal fade" id="taskListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">任务列表</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 任务分类标签 -->
                    <ul class="nav nav-tabs" id="taskListTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-tasks" type="button" role="tab">
                                未完成任务 <span id="pendingCount" class="badge bg-warning">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed-tasks" type="button" role="tab">
                                已完成任务 <span id="completedCount" class="badge bg-success">0</span>
                            </button>
                        </li>
                    </ul>
                    
                    <!-- 任务列表内容 -->
                    <div class="tab-content" id="taskListTabContent">
                        <div class="tab-pane fade show active" id="pending-tasks" role="tabpanel">
                            <div class="mt-3">
                                <div id="pendingTasksList" class="task-list">
                                    <!-- 未完成任务将在这里显示 -->
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="completed-tasks" role="tabpanel">
                            <div class="mt-3">
                                <div id="completedTasksList" class="task-list">
                                    <!-- 已完成任务将在这里显示 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="refreshTaskList()">刷新</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 任务详情蒙版 -->
    <div id="taskDetailOverlay" class="task-detail-overlay"></div>
    
    <!-- 任务详情模态框 -->
    <div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content task-detail-modal">
                <div class="modal-header task-detail-header">
                    <div class="d-flex align-items-center">
                        <div class="task-icon me-3">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div>
                            <h4 class="modal-title mb-0" id="taskDetailsModalLabel">任务详情 <span id="headerStatus" class="ms-2"></span></h4>
                            <small class="text-muted">Task Details</small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body task-detail-body-compact">
                    <!-- 统一的任务详情布局 -->
                    <div id="unifiedTaskLayout">
                        <!-- 第一行：基本信息和进度可视化 -->
                        <div class="row mb-4 equal-height-row">
                            <!-- 左侧：基本信息 -->
                            <div class="col-md-8">
                                <div class="task-section-compact">
                                    <h6 class="section-title-compact">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <span class="task-status-completed">基本信息</span>
                                        <span class="task-status-active">任务基本信息</span>
                                    </h6>
                                    <div class="section-content-compact">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="info-item-compact">
                                                    <label class="info-label-compact">
                                                        <i class="fas fa-tasks me-1"></i>
                                                        任务标题
                                                    </label>
                                                    <div id="detailTitle" class="info-value-compact fw-bold"></div>
                                                </div>
                                                <div class="info-item-compact">
                                                    <label class="info-label-compact">
                                                        <i class="fas fa-tag me-1"></i>
                                                        任务类型
                                                    </label>
                                                    <div id="detailType" class="info-value-compact"></div>
                                                </div>
                                                <div class="info-item-compact">
                                                    <label class="info-label-compact">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                        优先级
                                                    </label>
                                                    <div id="detailPriority" class="info-value-compact"></div>
                                                </div>

                                            </div>
                                            <div class="col-md-6">
                                                <div class="info-item-compact">
                                                    <label class="info-label-compact">
                                                        <i class="fas fa-calendar-alt me-1"></i>
                                                        开始日期
                                                    </label>
                                                    <div id="detailStartDate" class="info-value-compact"></div>
                                                </div>
                                                <div class="info-item-compact">
                                                    <label class="info-label-compact">
                                                        <i class="fas fa-calendar-times me-1"></i>
                                                        截止日期
                                                    </label>
                                                    <div id="detailDeadline" class="info-value-compact"></div>
                                                </div>
                                                <div class="info-item-compact task-status-completed">
                                                    <label class="info-label-compact">
                                                        <i class="fas fa-calendar-check me-1"></i>
                                                        完成日期
                                                    </label>
                                                    <div id="detailCompletedDate" class="info-value-compact"></div>
                                                </div>
                                                <!-- 创建时间已移除，为更重要信息腾出空间 -->
                                                <div class="info-item-compact task-status-active">
                                                    <label class="info-label-compact">
                                                        <i class="fas fa-edit me-1"></i>
                                                        最后更新
                                                    </label>
                                                    <div id="detailUpdatedAt" class="info-value-compact"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="info-item-compact mt-2">
                                            <label class="info-label-compact">
                                                <i class="fas fa-align-left me-1"></i>
                                                任务描述
                                            </label>
                                            <div id="detailDescription" class="info-value-compact description-value-compact"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右侧：进展历史 -->
                            <div class="col-md-4">
                                <!-- 统一的进展历史区域 -->
                                <div class="task-section-compact">
                                    <h6 class="section-title-compact">
                                        <i class="fas fa-history me-2"></i>
                                        进展历史
                                    </h6>
                                    <div class="section-content-compact">
                                        <!-- 进行中任务的进展历史 -->
                                        <div id="progressHistory" class="timeline-container task-status-active">
                                            <div class="text-center py-3 text-muted">
                                                <i class="fas fa-clock mb-2 d-block"></i>
                                                <small>暂无历史记录</small>
                                            </div>
                                        </div>
                                        
                                        <!-- 已完成任务的进展历史 -->
                                        <div id="progressHistoryCompleted" class="timeline-container task-status-completed">
                                            <div class="text-center py-3 text-muted">
                                                <i class="fas fa-clock mb-2 d-block"></i>
                                                <small>暂无历史记录</small>
                                            </div>
                                        </div>
                                        
                                        <!-- 未开始任务的进展历史 -->
                                        <div id="progressHistoryPending" class="timeline-container task-status-pending">
                                            <div class="text-center py-3 text-muted">
                                                <i class="fas fa-clock mb-2 d-block"></i>
                                                <small>暂无历史记录</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 第二行：进展操作功能区 -->
                        <div class="row mt-2">
                            <!-- 活动任务的操作功能区 -->
                            <div class="col-12 task-status-active">
                                <div class="task-section-compact">
                                    <h6 class="section-title-compact">
                                        <i class="fas fa-cogs me-2"></i>
                                        进展操作功能区
                                    </h6>
                                    <div class="section-content-compact">
                                        <!-- 平铺操作区域 -->
                                        <div class="progress-operations-grid">
                                            
                                            <!-- 任务进展 -->
                                            <div class="operation-item">
                                                <label for="detailProgress" class="operation-label">
                                                    <i class="fas fa-route me-1"></i>
                                                    任务进展
                                                </label>
                                                <select class="form-select form-select-sm" id="detailProgress">
                                                </select>
                                            </div>
                                            
                                            <!-- 任务状态切换 -->
                                            <div class="operation-item operation-item-wide">
                                                <label class="operation-label fw-bold text-primary">
                                                    <i class="fas fa-exchange-alt me-1"></i>
                                                    状态切换
                                                </label>
                                                <div class="d-grid gap-2">
                                                    <div class="btn-group w-100" role="group">
                                                        <button type="button" class="btn btn-primary" onclick="changeTaskStatus('in_progress')" id="statusBtn-in_progress">
                                                            <i class="fas fa-play me-1"></i>进行中
                                                        </button>
                                                        <button type="button" class="btn btn-success" onclick="changeTaskStatus('completed')" id="statusBtn-completed">
                                                            <i class="fas fa-check me-1"></i>已完成
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 第三行：已完成任务的复盘区域 -->
                        <div class="row mt-2 task-status-completed">
                            <div class="col-12">
                                <div class="task-section-compact">
                                    <h6 class="section-title-compact">
                                        <i class="fas fa-comments me-2"></i>
                                        任务复盘
                                    </h6>
                                    <div class="section-content-compact">
                                        <!-- 评论输入区 -->
                                        <div class="mb-3">
                                            <label for="reviewCommentCompleted" class="form-label">添加复盘评论</label>
                                            <textarea class="form-control" id="reviewCommentCompleted" rows="3" placeholder="请输入任务复盘内容，如经验总结、改进建议等..."></textarea>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-primary" onclick="addReviewCommentCompleted()">
                                                    <i class="fas fa-plus me-1"></i>
                                                    添加评论
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- 评论列表 -->
                                        <div id="reviewCommentsCompleted" class="review-comments">
                                            <div class="empty-state-compact">
                                                <i class="fas fa-comment-alt text-muted mb-2"></i>
                                                <p class="text-muted mb-0">暂无复盘评论</p>
                                                <small class="text-muted">添加评论来记录任务复盘内容</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer task-detail-footer">
                    <div id="taskActionButtons" class="d-flex justify-content-between align-items-center w-100">
                        <div>
                            <button type="button" class="btn btn-danger" onclick="window.TaskModule.showDeleteTaskConfirm()">
                                <i class="fas fa-trash-alt me-1"></i>
                                删除任务
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 问题详情模态框 -->
    <div class="modal fade" id="issueDetailsModal" tabindex="-1" aria-labelledby="issueDetailsModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-exclamation-circle text-warning"></i>
                        </div>
                        <div>
                            <h4 class="modal-title mb-0" id="issueDetailsModalLabel">问题详情</h4>
                            <small class="text-muted">Issue Details</small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <!-- 问题基本信息 -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        基本信息
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">问题标题</label>
                                                <div id="issueDetailTitle" class="text-break"></div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">优先级</label>
                                                <div id="issueDetailPriority"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">状态</label>
                                                <div id="issueDetailStatus"></div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">创建时间</label>
                                                <div id="issueDetailCreatedAt"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">问题描述</label>
                                        <div id="issueDetailDescription" class="text-break"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-cogs me-2"></i>
                                        操作
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button id="markResolvedBtn" class="btn btn-success" onclick="markIssueResolved()">
                                            <i class="fas fa-check me-2"></i>
                                            标记为已解决
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="editIssue()">
                                            <i class="fas fa-edit me-2"></i>
                                            编辑问题
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="window.IssueModule.showDeleteIssueConfirm()">
                                            <i class="fas fa-trash-alt me-2"></i>
                                            删除问题
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 解决方案区域 -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-lightbulb me-2"></i>
                                解决方案
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- 现有解决方案列表 -->
                            <div id="solutionsList" class="mb-3">
                                <!-- 解决方案将在这里显示 -->
                            </div>
                            
                            <!-- 添加新解决方案 -->
                            <div class="border-top pt-3">
                                <h6 class="mb-3">添加解决方案</h6>
                                <div class="mb-3">
                                    <textarea id="newSolutionText" class="form-control" rows="4" placeholder="请描述您的解决方案..."></textarea>
                                </div>
                                <button class="btn btn-primary" onclick="addSolution()">
                                    <i class="fas fa-plus me-2"></i>
                                    添加解决方案
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 删除任务确认对话框 -->
    <div class="modal fade" id="deleteTaskConfirmModal" tabindex="-1" aria-labelledby="deleteTaskConfirmModalLabel">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteTaskConfirmModalLabel">
                        <i class="fas fa-trash-alt text-danger me-2"></i>确认删除任务
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h6 class="mb-3">您确定要删除此任务吗？</h6>
                        <p class="text-muted mb-0">此操作将永久删除该任务，且无法恢复。</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteTaskBtn">
                        <i class="fas fa-trash-alt me-1"></i>确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 删除问题确认对话框 -->
    <div class="modal fade" id="deleteIssueConfirmModal" tabindex="-1" aria-labelledby="deleteIssueConfirmModalLabel">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteIssueConfirmModalLabel">
                        <i class="fas fa-trash-alt text-danger me-2"></i>确认删除问题
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h6 class="mb-3">您确定要删除此问题吗？</h6>
                        <p class="text-muted mb-0">此操作将永久删除该问题，且无法恢复。</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteIssueBtn">
                        <i class="fas fa-trash-alt me-1"></i>确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 完成任务确认对话框 -->
    <div class="modal fade" id="completeTaskConfirmModal" tabindex="-1" aria-labelledby="completeTaskConfirmModalLabel">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="completeTaskConfirmModalLabel">
                        <i class="fas fa-check-circle text-success me-2"></i>确认完成任务
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-question-circle text-warning" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h6 class="mb-3">您确定要将此任务标记为已完成吗？</h6>
                        <p class="text-muted mb-0">此操作将把任务状态更改为"已完成"，任务将从进行中列表移除。</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-success" id="confirmCompleteTaskBtn">
                        <i class="fas fa-check me-1"></i>确认完成
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 工作流配置模态框 -->
    <div class="modal fade" id="workflowConfigModal" tabindex="-1" data-bs-backdrop="false">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-list me-2"></i>
                        工作流列表
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 工作流类型列表视图 -->
                    <div id="workflowListView" class="workflow-list-view">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">工作类型清单</h6>
                            <button class="btn btn-primary btn-sm" onclick="showCreateWorkflowForm()">
                                <i class="fas fa-plus me-1"></i>新建工作流类型
                            </button>
                        </div>
                        <div id="workflowTypeList" class="workflow-type-list">
                            <!-- 工作流类型列表将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 工作流步骤管理视图 -->
                    <div id="workflowStepsView" class="workflow-steps-view" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <button class="btn btn-outline-secondary btn-sm me-2" onclick="backToWorkflowList()">
                                    <i class="fas fa-arrow-left me-1"></i>返回
                                </button>
                                <h6 class="mb-0 d-inline" id="currentWorkflowName">工作流步骤管理</h6>
                            </div>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="window.WorkflowModule.addWorkflowStep()">
                                    <i class="fas fa-plus me-1"></i>添加步骤
                                </button>
                            </div>
                        </div>
                        <div id="workflowStepsList" class="workflow-steps-list">
                            <!-- 工作流步骤列表将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 创建/编辑工作流表单 -->
                    <div id="workflowForm" class="workflow-form" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0" id="workflowFormTitle">新建工作流类型</h6>
                            <button class="btn btn-outline-secondary btn-sm" onclick="hideWorkflowForm()">
                                <i class="fas fa-arrow-left me-1"></i>返回
                            </button>
                        </div>
                        <form id="workflowEditForm">
                            <input type="hidden" id="editWorkflowId">
                            
                            <div class="mb-3">
                                <label for="workflowName" class="form-label">工作流名称</label>
                                <input type="text" class="form-control" id="workflowName" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="workflowDescription" class="form-label">描述</label>
                                <textarea class="form-control" id="workflowDescription" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isDefaultWorkflow">
                                    <label class="form-check-label" for="isDefaultWorkflow">
                                        设为默认工作流
                                    </label>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success" id="saveWorkflowBtn" onclick="saveWorkflow()">
                                    <i class="fas fa-save me-1"></i>保存工作流
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideWorkflowForm()">
                                    <i class="fas fa-times me-1"></i>取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 步骤管理模态框 -->
    <div class="modal fade" id="stepManageModal" tabindex="-1" aria-labelledby="stepManageModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stepManageModalLabel">管理步骤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <form id="stepManageForm">
                        <div class="mb-3">
                            <label for="stepTitle" class="form-label">步骤标题</label>
                            <input type="text" class="form-control" id="stepTitle" placeholder="请输入步骤标题" required>
                        </div>
                        <div class="mb-3">
                            <label for="stepDescription" class="form-label">步骤描述（可选）</label>
                            <textarea class="form-control" id="stepDescription" rows="3" placeholder="请输入步骤描述"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveStepBtn">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='libs/bootstrap.bundle.min.js') }}"></script>
    <script src="/static/libs/fullcalendar/index.global.min.js"></script>
    <script src="{{ url_for('static', filename='libs/chart.min.js') }}"></script>
    
    <!-- 模块化JavaScript文件 -->
    <script src="{{ url_for('static', filename='js/modules/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/calendar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/chart.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/task.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/issue.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/workflow.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // 调试工作流清单功能
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                console.log('=== 工作流清单调试 ===');
                const modal = document.getElementById('workflowConfigModal');
                const button = document.querySelector('[data-bs-target="#workflowConfigModal"]');
                const listContainer = document.getElementById('workflowTypeList');
                const listView = document.getElementById('workflowListView');
                
                console.log('模态框元素:', modal ? '存在' : '不存在');
                console.log('按钮元素:', button ? '存在' : '不存在');
                console.log('列表容器:', listContainer ? '存在' : '不存在');
                console.log('列表视图:', listView ? '存在' : '不存在');
                console.log('Bootstrap版本:', typeof bootstrap !== 'undefined' ? 'Bootstrap已加载' : 'Bootstrap未加载');
                
                if (button) {
                    button.addEventListener('click', function() {
                        console.log('工作流按钮被点击');
                        setTimeout(function() {
                            console.log('模态框显示状态:', modal.classList.contains('show') ? '已显示' : '未显示');
                            console.log('列表视图显示状态:', listView ? (listView.style.display === 'none' ? '隐藏' : '显示') : '不存在');
                        }, 500);
                    });
                }
                
                // 监听模态框显示事件
                if (modal) {
                    modal.addEventListener('show.bs.modal', function() {
                        console.log('模态框显示事件触发');
                    });
                    modal.addEventListener('shown.bs.modal', function() {
                        console.log('模态框已完全显示');
                        console.log('当前视图:', listView ? (listView.style.display === 'none' ? '隐藏' : '显示') : '不存在');
                        
                        // 确保显示工作流列表视图
                        if (window.WorkflowModule) {
                            console.log('调用showWorkflowListView方法');
                            window.WorkflowModule.showWorkflowListView();
                        } else {
                            console.error('WorkflowModule未找到');
                        }
                    });
                }
                
                // 手动测试按钮已删除
            }, 1000);
        });
    </script>
    
    <!-- 引入模态弹窗工具类 -->
    <script src="/static/js/modules/modal-utils.js"></script>
    
    <!-- 编辑问题模态框 -->
    <div class="modal fade" id="editIssueModal" tabindex="-1" aria-labelledby="editIssueModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editIssueModalLabel">编辑问题</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <form id="editIssueForm">
                        <input type="hidden" id="editIssueId">
                        <div class="mb-3">
                            <label for="editIssueTitle" class="form-label">问题标题</label>
                            <input type="text" class="form-control" id="editIssueTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editIssueDescription" class="form-label">问题描述</label>
                            <textarea class="form-control" id="editIssueDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editIssuePriority" class="form-label">优先级</label>
                            <select class="form-select" id="editIssuePriority">
                                <option value="low">低</option>
                                <option value="medium">中</option>
                                <option value="high">高</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveIssueEdit()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 初始化统一模态弹窗效果 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 确保ModalUtils已加载
            if (window.ModalUtils) {
                window.ModalUtils.initModalEffects();
            }
        });
    </script>
</body>
</html>